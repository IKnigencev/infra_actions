# .github/workflows/**main.yml**
name: Django-app workflow

on: [push]

jobs:
  tests:
    # «Раннер» — создание изолированного окружения с последней версией Ubuntu 
    runs-on: ubuntu-latest

    steps:
    # Запуск actions checkout — готового скрипта 
    # для клонирования репозитория
    - uses: actions/checkout@v2
    - name: Set up Python
      # Запуск actions setup-python — готового скрипта 
      # для развёртывания окружения Python
      uses: actions/setup-python@v2
      with:
        # Выбор версии Python
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # обновление pip
        python -m pip install --upgrade pip 
        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # установка зависимостей
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        cd infra_project/
        python manage.py test
  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: knigencev/infra_actions:latest
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAxU6d7X1pnMl38llkWpL4x1wH/VZ+T1IxMeK9u3oRlc9cYZOKXK0Z
1c2DEH8MVXrcKLvq0ZDcgoEI9ySlPrz5i9s8L8ECTj9OTEUF/VBL/6XvmgXbY9tBNWxNWN
zrDurQKQPyjKjw5TQlnRjKu4ft59kINTwc1EJk/6cCmyksxF8dEn3Zk1qiptgH6oiW8BTI
PzNWZX8KSeiy13kuFTktLOCLB9U1ygSkiXzQrfrtgm8Jc2TSvmgVZiwdbbYyPaii9mhZiR
oYMSkiBDnEt/OadVN3ysVkwnijHaflrGrR2f9vMr1deun2TDAcsf1iOh5zUnS1E5ySw4Tc
UDKAj41quNdWFR9B813sKsgFTckKWyXtzjAXR/Os8NY6gxceGhqCod94p9WfMmCisNWf4o
IUTZS3euhOD5JQQcMsXEpu5NHt8aB0EZsdmBkiSnbjIYHxE5io+hlFDmEDW4l2C+nI6kZl
BUNNm4KbBa/OGtn3eplnojyZ6hevI1NuI6Wh0Do5AAAFgL3jWIm941iJAAAAB3NzaC1yc2
EAAAGBAMVOne19aZzJd/JZZFqS+MdcB/1Wfk9SMTHivbt6EZXPXGGTilytGdXNgxB/DFV6
3Ci76tGQ3IKBCPckpT68+YvbPC/BAk4/TkxFBf1QS/+l75oF22PbQTVsTVjc6w7q0CkD8o
yo8OU0JZ0YyruH7efZCDU8HNRCZP+nApspLMRfHRJ92ZNaoqbYB+qIlvAUyD8zVmV/Ckno
std5LhU5LSzgiwfVNcoEpIl80K367YJvCXNk0r5oFWYsHW22Mj2oovZoWYkaGDEpIgQ5xL
fzmnVTd8rFZMJ4ox2n5axq0dn/bzK9XXrp9kwwHLH9Yjoec1J0tROcksOE3FAygI+NarjX
VhUfQfNd7CrIBU3JClsl7c4wF0fzrPDWOoMXHhoagqHfeKfVnzJgorDVn+KCFE2Ut3roTg
+SUEHDLFxKbuTR7fGgdBGbHZgZIkp24yGB8ROYqPoZRQ5hA1uJdgvpyOpGZQVDTZuCmwWv
zhrZ93qZZ6I8meoXryNTbiOlodA6OQAAAAMBAAEAAAGADoYkPXZxJwu0kuguKTWu7vvxEZ
7DkwK1oNq0RT/t2fWG8x7ZfUt3vqOPbZAwn/04hh4ZIb6UYN3vQ0QVDup5wygLBOfkC88A
rEAbegNmaMX1/oRGW1IpOW3EvtEaU4GI+6/w85Y/D1w4lZkc2VOe+WViQ4rug1h011XbrQ
DJrRXkTbdqY/y0wuvdn0/ZLoiVGgPlLPj+UKT6vz5KHGFWWDqaOWQiPsH7O6yurtPtFmAm
lbI7Ci2ev6PpMamLBrtqTFC/kckYbSXA0K3c3uOg6z8ky62HP33ma6n2n9j1cmthYT7vbs
/+wYKieOjbtOGWffaBkiD8MzqJw0uiK5ypocqtdlvhzGmjCCs6ggR2YJrN+lCqRvnG8TPz
4C92pLWbu5U+uHZP7XH2WNWPdpeUsgUu1OXXXWLuUCpnLe5s5brNK93kWXYpHGethJ0Wja
wTRXPFOJDr65h6R601+PSgqc84Zvb6o6OE9+lb14bM/Rpv8qNBK6ZszaE0jKmzaS4hAAAA
wA1a1tJATtbNWgQ9AyUnHQH4GLxWLYrsoL7cu/j36r+zIdzv3+++v1KHemCCi2yldPW9yb
AeyL2dBr4a5y+KyJLa1JRfJyPhiaTpp7D/iFUy6G60uCW1o/7N3jU8f0zeK6lrL+5TDXdE
SevU0/ivHzTOpcOpUQlzf/AXz07VjYiz7MRsmiFkK1yMmwLIfsnIiCjMX0HjAmlf53mJGx
zvV/l6amnlBRw7gxWIv6jNJ9yLqh+W30judIMP9eiSfZCFtwAAAMEA+GKCEv7TPd4wO/Pz
VqgsZ5ZAD2LfPg0EhJxhcXnM3kTzPDQn8wXnooT4pf7WrOEdI0kV9FOZZSyAlVBwDnisF7
QqK4+qGgLb8V44BHiAA165Jvor89UQFccrzfw9sXbxd/H+711ClTE0S3ddXXaMS/GB7GQe
OEDZA9pMPPhZ8f+ETccN6oESZw6fHuIbz3mwa6pC0a7mz/rphGLJufkiJN2pyJj6EeSVu+
S8GAKyngSI5LuimNcTp623ERGorIBpAAAAwQDLWzdqL0OBNMqtRC75SWxxGbiwop1y2RI8
o1WK+QRF/TlzywOHvEf/3ZSK9j9dJZjAfVqAbmhNqCEMdo5cqR2J/26Pc3ycZoPgg+Mpqa
tHkgDeT7DX3Usz3nw9c47Fn1aR0TqJEWGaDAjTnbyTL0Fl0WJCh/DJmTMMQXMYZ0As2frN
6c+uRYpEHa+wlWSr7mLhsMf3PjSPYb4wRk4sauhPXyRSp2b3agLTCtrGuUKBXcW6sZ+yzs
juM5NXEmx7sVEAAAALaXZhbkBmZWRvcmE=
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull knigencev/infra_actions
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 knigencev/infra_actions
